<div id="pipelines-container">
  <div id="pipelines-header">Annotation pipelines</div>
  <div>
    <input
      placeholder="Select pipeline"
      [title]="selectedPipeline ? selectedPipeline.id : ''"
      id="pipelines-input"
      matInput
      #pipelineInput="matAutocompleteTrigger"
      [matAutocomplete]="pipelinesDropdown"
      [formControl]="dropdownControl"
      (click)="clearPipeline()" />
    <span (click)="clearPipeline(); pipelineInput.openPanel()" class="material-symbols-outlined dropdown-icon"
      >keyboard_arrow_down</span
    >
  </div>

  <mat-autocomplete #pipelinesDropdown="matAutocomplete">
    @for (group of ['default', 'user']; track group) {
    <mat-optgroup [label]="group === 'user' ? 'User pipelines' : 'Public pipelines'">
      @for (pipeline of filteredPipelines; track pipeline.id) {
      <mat-option
        *ngIf="pipeline.type === group"
        class="pipeline-option"
        (click)="onPipelineClick(pipeline)"
        (onSelectionChange)="onPipelineClick(pipeline)"
        [title]="pipeline.name"
        [value]="pipeline.name">
        <span id="socket-notification">
          <span [ngClass]="pipeline.status + '-circle'" class="material-symbols-outlined pipeline-status-icon"
            >circle</span
          ></span
        >
        {{ pipeline.name }}
      </mat-option>
      }
    </mat-optgroup>
    }
  </mat-autocomplete>

  <ngx-monaco-editor
    #pipelineEditor
    id="pipeline-editor"
    [ngClass]="[configError ? 'invalid-config' : '', selectedPipeline ? selectedPipeline.status + '-editor' : '']"
    [style.width]="editorWidth()"
    [style.height]="editorHeight()"
    [options]="yamlEditorOptions"
    (onInit)="onEditorInit()"
    [(ngModel)]="currentPipelineText"
    (ngModelChange)="isConfigValid()"></ngx-monaco-editor>
  <div *ngIf="configError" class="error-message">{{ configError }}</div>
</div>

<div id="pipeline-actions">
  <div>
    <button (click)="clearPipeline()" id="add-button"
      ><span class="material-symbols-outlined add-icon">add</span>New</button
    >
    <button *ngIf="isUserLoggedIn" (click)="saveAs()" id="save-as-button" [disabled]="configError"
      ><span class="material-symbols-outlined save-as-icon">save_as</span>Save as</button
    >
    <button
      *ngIf="isUserLoggedIn && selectedPipeline && selectedPipeline.type === 'user'"
      (click)="save()"
      id="save-button"
      [disabled]="!isPipelineChanged() || configError"
      ><span class="material-symbols-outlined save-icon">save</span>Save</button
    >

    @if(showConfimDeletePopup) {
    <div id="confirmation-popover">
      <p>Are you sure you want to delete the pipeline?</p>
      <div>
        <button id="confirm-delete" (click)="delete()">Delete</button>
        <button id="cancel-delete" (click)="showConfimDeletePopup = false">Cancel</button>
      </div>
    </div>
    }

    <button
      *ngIf="isUserLoggedIn && selectedPipeline && selectedPipeline.type === 'user'"
      (click)="confirmDeletePipeline()"
      id="delete-button"
      ><span class="material-symbols-outlined delete-icon">delete</span>Delete</button
    >
  </div>
  <div>
    <button *ngIf="displayResetScreenButton" (click)="shrinkTextarea()" id="shrink-button"
      ><span class="material-symbols-outlined shrink-icon">close_fullscreen</span>Reset</button
    >
    <button *ngIf="displayFullScreenButton" (click)="expandTextarea()" id="expand-button"
      ><span class="material-symbols-outlined expand-icon">open_in_full</span>Full screen</button
    >
  </div>
</div>

<ng-template #nameInput>
  <div id="name-modal">
    <div>Set pipeline name</div>
    <input #inputRef (keydown.enter)="saveName(inputRef.value)" />
    <div id="buttons-wrapper">
      <button id="save-name-button" (click)="saveName(inputRef.value)">Save</button>
      <button id="cancel-button" (click)="cancel()">Cancel</button>
    </div>
  </div>
</ng-template>

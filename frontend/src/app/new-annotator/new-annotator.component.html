<div id="modal-header">New annotator</div>
<div style="height: 100%">
  <mat-stepper #stepper [linear]="true" class="custom-stepper">
    <mat-step label="Select annotator" [editable]="false" [stepControl]="annotatorStep">
      <form [formGroup]="annotatorStep" id="annotator-input-form">
        <mat-form-field [appearance]="'outline'">
          <input
            type="text"
            placeholder="Select annotator"
            autocomplete="off"
            matInput
            formControlName="annotator"
            [matAutocomplete]="annotatorsDropdown"
            #annotatorInput="matAutocompleteTrigger"
            #annotatorInputValue
            [title]="annotatorInputValue.value"
            (click)="clearAnnotator()" />
          <span (click)="annotatorInput.openPanel(); clearAnnotator()" class="material-symbols-outlined dropdown-icon"
            >keyboard_arrow_down</span
          >

          <mat-autocomplete #annotatorsDropdown="matAutocomplete">
            @for (annotator of filteredAnnotators; track annotator) {
            <mat-option class="annotator-option" [value]="annotator" [title]="annotator">{{ annotator }}</mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>

        <div>
          <button matButton [disabled]="annotatorStep.invalid" (click)="requestResources()" class="next-button"
            >Next</button
          >
        </div>
      </form>
    </mat-step>

    <mat-step label="Select resource" [editable]="false" [stepControl]="resourceStep">
      <ng-template matStepContent>
        <div class="summary-content">
          <div class="annotator-display-text">{{ annotatorStep.value | keyValueDisplay }}</div>
        </div>

        <div class="left-content">
          <form [formGroup]="resourceStep">
            <div>
              <div class="field">
                <span class="field-label">input annotatable</span>
                <input
                  id="input-annotatable-field"
                  type="text"
                  [formControlName]="'input_annotatable'"
                  autocomplete="off"
                  #inputAnnotatableValue
                  [title]="inputAnnotatableValue.value" />
              </div>

              @for (resource of annotatorConfig.resources; track resource) {
              <div class="field">
                <span class="resource field-label">{{ resource.key }}</span>

                @if(resource.fieldType === 'resource') {
                <mat-form-field [appearance]="'outline'" class="resource-input">
                  <input
                    type="text"
                    placeholder="Select resource"
                    autocomplete="off"
                    matInput
                    [formControlName]="resource.key"
                    [matAutocomplete]="resourcesDropdown"
                    #resourceInput="matAutocompleteTrigger"
                    #resourceInputValue
                    [title]="resourceInputValue.value"
                    (click)="clearResource(resource.key)" />
                  <span
                    (click)="resourceInput.openPanel(); clearResource(resource.key)"
                    class="material-symbols-outlined dropdown-icon"
                    >keyboard_arrow_down</span
                  >

                  <mat-autocomplete #resourcesDropdown="matAutocomplete">
                    @for (r of filteredResourceValues.get(resource.key); track $index) {
                    <mat-option class="resource-option" [value]="r" [title]="r">{{ r }}</mat-option>
                    }
                  </mat-autocomplete>
                </mat-form-field>
                } @else if(resource.fieldType === 'string') {
                <input class="resource-field" type="text" [formControlName]="resource.key" autocomplete="off" />
                } @else if(resource.fieldType === 'bool') {
                <div>
                  <input type="radio" [formControlName]="resource.key" for="true" />
                  <label name="true">True</label>
                  <input type="radio" [formControlName]="resource.key" for="false" />
                  <label name="false">False</label>
                </div>
                }
              </div>
              }
            </div>
            <div>
              <button matButton [disabled]="resourceStep.invalid" (click)="requestAttributes()" class="next-button"
                >Next</button
              >
            </div>
          </form>
        </div>
      </ng-template>
    </mat-step>

    <mat-step label="Attributes" [editable]="false">
      <ng-template matStepContent>
        <div class="summary-content">
          <div class="annotator-display-text" [title]="annotatorStep.value | keyValueDisplay">{{
            annotatorStep.value | keyValueDisplay
          }}</div>
          <div class="resources-display-text" [title]="resourceStep.value | keyValueDisplay">{{
            resourceStep.value | keyValueDisplay
          }}</div>
        </div>

        <div class="left-content">
          <div id="attributes-list">
            @for (attribute of annotatorAttributes; track attribute) { @if(attribute.selectedByDefault) {
            <div class="attribute-group">
              <div class="attribute">
                <span class="field-label">name</span>
                <span [title]="attribute.name" class="field-value">{{ attribute.name }}</span>
              </div>
              <div class="attribute">
                <span class="field-label">source</span>
                <span class="field-value">{{ attribute.source }}</span>
              </div>
              <div class="attribute">
                <span class="field-label">internal</span>
                <span class="field-value">{{ attribute.internal }}</span>
              </div>
            </div>
            } }
          </div>
          <div>
            <button matButton (click)="onFinish()" class="finish-button">Finish</button>
            <button matButton matStepperNext class="next-button">Next</button>
          </div>
        </div>
      </ng-template>
    </mat-step>
    <mat-step label="Modify attributes" [editable]="false" [optional]="true">
      <ng-template matStepContent>
        <div class="summary-content">
          <div class="annotator-display-text" [title]="annotatorStep.value | keyValueDisplay">{{
            annotatorStep.value | keyValueDisplay
          }}</div>
          <div class="resources-display-text" [title]="resourceStep.value | keyValueDisplay">{{
            resourceStep.value | keyValueDisplay
          }}</div>
        </div>

        <div class="left-content">
          <div id="attributes-list">
            @for (attribute of annotatorAttributes; track attribute) {
            <div class="attribute-group modify-view-group">
              <input
                type="checkbox"
                [checked]="selectedAttributes.includes(attribute)"
                (change)="toggleSelectedAttribute(attribute)" />
              <div style="width: 100%">
                <div class="attribute modify-view-attribute">
                  <span class="field-label">name</span>
                  <input
                    class="editable-name"
                    type="text"
                    [title]="attribute.name"
                    [value]="attribute.name"
                    [(ngModel)]="attribute.name" />
                </div>
                <div class="attribute modify-view-attribute">
                  <span class="field-label">source</span>
                  <span>{{ attribute.source }}</span>
                </div>
                <div class="attribute modify-view-attribute">
                  <span class="field-label">internal</span>
                  <div>
                    <input
                      type="radio"
                      [id]="attribute.name + '-internal-true'"
                      [name]="attribute.name + 'is-internal'"
                      [value]="attribute.name + '-internal-true'"
                      [checked]="attribute.internal === true"
                      (click)="setAttributeInternal(attribute, true)" />
                    <label [for]="attribute.name + '-internal-true'" class="internal-value">True</label>
                    <input
                      type="radio"
                      [id]="attribute.name + '-internal-false'"
                      [name]="attribute.name + 'is-internal'"
                      [value]="attribute.name + '-internal-false'"
                      [checked]="attribute.internal === false"
                      (click)="setAttributeInternal(attribute, false)" />
                    <label [for]="attribute.name + '-internal-false'" class="internal-value">False</label>
                  </div>
                </div>
              </div>
            </div>
            }
          </div>
          <div>
            <button matButton (click)="onFinish()" class="finish-button">Finish</button>
          </div>
        </div>
      </ng-template>
    </mat-step>
  </mat-stepper>
</div>
